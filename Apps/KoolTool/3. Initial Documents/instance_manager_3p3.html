<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE BRIDGE - Instance Manager 3P3</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #94a3b8;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text);
            line-height: 1.6;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow);
        }
        
        .logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            flex: 1;
        }
        
        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .nav-tab.active {
            background: var(--primary);
            color: white;
        }
        
        /* Sub Navigation - Process Tabs */
        .process-tabs {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            display: flex;
            gap: 2px;
            overflow-x: auto;
        }
        
        .process-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
        }
        
        .process-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .process-tab .badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Left Panel - Filters */
        .left-panel {
            width: 200px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            padding: 16px;
            overflow-y: auto;
        }
        
        .filter-section {
            margin-bottom: 24px;
        }
        
        .filter-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .filter-option {
            padding: 6px 8px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            font-size: 13px;
        }
        
        .filter-option:hover {
            background: var(--bg-secondary);
        }
        
        .filter-option.active {
            background: #e6f2ff;
            color: var(--primary);
        }
        
        .filter-count {
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* Center Panel */
        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }
        
        /* Action Bar */
        .action-bar {
            background: var(--bg-primary);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .action-bar-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .view-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 6px;
        }
        
        .view-btn {
            padding: 6px 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--secondary);
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .view-btn.active {
            background: var(--bg-primary);
            color: var(--primary);
        }
        
        /* Instances List */
        .instances-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        /* Table View */
        .instances-table {
            background: var(--bg-primary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 120px 1fr 120px 150px 120px 100px 120px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 120px 1fr 120px 150px 120px 100px 120px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            align-items: center;
        }
        
        .table-row:hover {
            background: var(--bg-secondary);
        }
        
        .table-row.selected {
            background: #e6f2ff;
        }
        
        .table-row.expanded {
            background: #f0f9ff;
        }
        
        /* Instance Detail (Expanded Row) */
        .instance-detail {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            display: none;
        }
        
        .instance-detail.active {
            display: block;
        }
        
        .detail-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 6px;
        }
        
        .form-input, .form-select, .form-textarea {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        /* Status Badge */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-progress {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* DNA Badge */
        .dna-badge {
            font-family: monospace;
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            color: var(--primary);
            font-weight: 600;
        }
        
        /* Breadcrumb DNA */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            color: var(--secondary);
        }
        
        .breadcrumb-item {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }
        
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        
        .breadcrumb-separator {
            color: var(--text-light);
        }
        
        /* Right Panel - Inspector */
        .right-panel {
            width: 300px;
            background: var(--bg-primary);
            border-left: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
        }
        
        .inspector-section {
            margin-bottom: 24px;
        }
        
        .inspector-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .state-indicator {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-align: center;
            margin-bottom: 12px;
        }
        
        .state-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .state-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .state-time {
            font-size: 12px;
            color: var(--secondary);
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .btn-full {
            width: 100%;
            justify-content: center;
        }
        
        /* History Timeline */
        .timeline {
            position: relative;
            padding-left: 24px;
        }
        
        .timeline:before {
            content: '';
            position: absolute;
            left: 8px;
            top: 8px;
            bottom: 8px;
            width: 2px;
            background: var(--border);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 16px;
        }
        
        .timeline-dot {
            position: absolute;
            left: -20px;
            top: 4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid white;
        }
        
        .timeline-content {
            font-size: 13px;
        }
        
        .timeline-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .timeline-time {
            font-size: 11px;
            color: var(--secondary);
        }
        
        /* K Coefficient Display */
        .k-display {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            text-align: center;
        }
        
        .k-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .k-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .k-status {
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            font-size: 11px;
            display: inline-block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary);
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--text);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: var(--shadow-lg);
            display: none;
            animation: slideIn 0.3s;
            z-index: 2000;
        }
        
        .toast.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        /* Process Tree in Modal */
        .process-tree {
            margin-bottom: 20px;
        }
        
        .tree-node {
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .tree-node:hover {
            background: var(--bg-secondary);
        }
        
        .tree-node.selected {
            background: #e6f2ff;
            color: var(--primary);
        }
        
        .tree-node-indent {
            padding-left: 24px;
        }
        
        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--secondary);
            text-transform: uppercase;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .left-panel {
                width: 60px;
            }
            
            .filter-title,
            .filter-option span {
                display: none;
            }
            
            .right-panel {
                width: 200px;
            }
        }
    </style>
<link rel="icon" type="image/png" href="https://caufero.github.io/projects/Apps/CarePort/Screenshots/caufero_logo.png">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">THE BRIDGE</div>
            <div class="nav-tabs">
                <button class="nav-tab">Model Manager</button>
                <button class="nav-tab">Process Manager</button>
                <button class="nav-tab active">Instance Manager</button>
                <button class="nav-tab">Dashboard</button>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 13px; color: var(--secondary);">User: Sara Bianchi</span>
                <button class="btn btn-secondary" onclick="location.reload()">
                    üîÑ Refresh
                </button>
            </div>
        </div>
        
        <!-- Process Tabs -->
        <div class="process-tabs">
            <button class="process-tab active" onclick="switchProcess('ALL')">
                All Processes
                <span class="badge">12</span>
            </button>
            <button class="process-tab" onclick="switchProcess('PHO')">
                üìû Phone Calls
            </button>
            <button class="process-tab" onclick="switchProcess('VIS')">
                üöó Visits
            </button>
            <button class="process-tab" onclick="switchProcess('PRJ')">
                üìÅ Projects
            </button>
            <button class="process-tab" onclick="switchProcess('OFC')">
                üíº Offers
            </button>
            <button class="process-tab" onclick="switchProcess('BOM')">
                üì¶ Bill of Materials
            </button>
            <button class="process-tab" onclick="switchProcess('ORD')">
                üìã Orders
            </button>
        </div>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Panel - Filters -->
            <div class="left-panel">
                <div class="filter-section">
                    <div class="filter-title">Status</div>
                    <div class="filter-option active" onclick="filterByStatus('ALL')">
                        <span>All</span>
                        <span class="filter-count">12</span>
                    </div>
                    <div class="filter-option" onclick="filterByStatus('NEW')">
                        <span>New</span>
                        <span class="filter-count">3</span>
                    </div>
                    <div class="filter-option" onclick="filterByStatus('IN_PROGRESS')">
                        <span>In Progress</span>
                        <span class="filter-count">5</span>
                    </div>
                    <div class="filter-option" onclick="filterByStatus('COMPLETED')">
                        <span>Completed</span>
                        <span class="filter-count">4</span>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-title">Assignee</div>
                    <div class="filter-option active">
                        <span>All Users</span>
                    </div>
                    <div class="filter-option">
                        <span>My Instances</span>
                    </div>
                    <div class="filter-option">
                        <span>Unassigned</span>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-title">Date Range</div>
                    <div class="filter-option active">
                        <span>Today</span>
                    </div>
                    <div class="filter-option">
                        <span>This Week</span>
                    </div>
                    <div class="filter-option">
                        <span>This Month</span>
                    </div>
                </div>
            </div>
            
            <!-- Center Panel -->
            <div class="center-panel">
                <!-- Action Bar -->
                <div class="action-bar">
                    <div class="action-bar-left">
                        <button class="btn btn-primary" onclick="openNewInstanceModal()">
                            + New Instance
                        </button>
                        <input type="search" placeholder="Search instances..." 
                               style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 250px;">
                    </div>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="switchView('table')">üìã Table</button>
                        <button class="view-btn" onclick="switchView('kanban')">üìä Kanban</button>
                        <button class="view-btn" onclick="switchView('timeline')">üìÖ Timeline</button>
                    </div>
                </div>
                
                <!-- Instances List -->
                <div class="instances-container">
                    <div class="instances-table" id="instancesTable">
                        <div class="table-header">
                            <div>DNA</div>
                            <div>Description</div>
                            <div>Status</div>
                            <div>Created</div>
                            <div>Assignee</div>
                            <div>K Coeff</div>
                            <div>Actions</div>
                        </div>
                        
                        <!-- Instance Row 1 - Completed Call -->
                        <div class="table-row" onclick="toggleInstanceDetail(this, 'PHO250041')">
                            <div class="dna-badge">PHO250041</div>
                            <div>Mario Rossi - Product inquiry</div>
                            <div><span class="status-badge status-completed">COMPLETED</span></div>
                            <div>2025-01-15 10:00</div>
                            <div>Sara Bianchi</div>
                            <div>1.15 ‚úÖ</div>
                            <div>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); viewInstance('PHO250041')">üëÅÔ∏è</button>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); editInstance('PHO250041')">‚úèÔ∏è</button>
                            </div>
                        </div>
                        <div class="instance-detail" id="detail-PHO250041">
                            <div class="breadcrumb">
                                <span class="breadcrumb-item">Phone Call</span>
                                <span class="breadcrumb-separator">‚Üí</span>
                                <span class="breadcrumb-item">PHO250041</span>
                            </div>
                            <div class="detail-form">
                                <div class="form-group">
                                    <label class="form-label">Caller Name</label>
                                    <input type="text" class="form-input" value="Mario Rossi" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-input" value="+39 02 1234567" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration (min)</label>
                                    <input type="number" class="form-input" value="12" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Outcome</label>
                                    <select class="form-select" disabled>
                                        <option selected>INTERESTED</option>
                                        <option>NOT_INTERESTED</option>
                                        <option>CALLBACK</option>
                                        <option>NO_ANSWER</option>
                                    </select>
                                </div>
                                <div class="form-group full-width">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-textarea" readonly>Customer interested in spring catalog. Requesting samples of blonde extensions.</textarea>
                                </div>
                            </div>
                            <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-top: 16px;">
                                <strong>üéØ Trigger Alert:</strong> Outcome = INTERESTED ‚Üí Suggest creating Offer (OFC)
                                <button class="btn btn-primary btn-sm" style="margin-left: 12px;" onclick="createLinkedInstance('OFC', 'PHO250041')">
                                    Create Offer
                                </button>
                            </div>
                        </div>
                        
                        <!-- Instance Row 2 - In Progress Call -->
                        <div class="table-row" onclick="toggleInstanceDetail(this, 'PHO250042')">
                            <div class="dna-badge">PHO250042</div>
                            <div>Giulia Verdi - Support request</div>
                            <div><span class="status-badge status-progress">IN_PROGRESS</span></div>
                            <div>2025-01-15 14:30</div>
                            <div>Sara Bianchi</div>
                            <div>‚è≥</div>
                            <div>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); viewInstance('PHO250042')">üëÅÔ∏è</button>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); editInstance('PHO250042')">‚úèÔ∏è</button>
                            </div>
                        </div>
                        <div class="instance-detail" id="detail-PHO250042">
                            <div class="breadcrumb">
                                <span class="breadcrumb-item">Phone Call</span>
                                <span class="breadcrumb-separator">‚Üí</span>
                                <span class="breadcrumb-item">PHO250042</span>
                            </div>
                            <div class="detail-form">
                                <div class="form-group">
                                    <label class="form-label">Caller Name</label>
                                    <input type="text" class="form-input" value="Giulia Verdi">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-input" value="+39 06 9876543">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration (min)</label>
                                    <input type="number" class="form-input" value="" placeholder="Ongoing...">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Outcome</label>
                                    <select class="form-select">
                                        <option value="">-- Select --</option>
                                        <option>INTERESTED</option>
                                        <option>NOT_INTERESTED</option>
                                        <option>CALLBACK</option>
                                        <option>NO_ANSWER</option>
                                    </select>
                                </div>
                                <div class="form-group full-width">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-textarea" placeholder="Add notes..."></textarea>
                                </div>
                            </div>
                            <div class="action-buttons" style="margin-top: 16px;">
                                <button class="btn btn-success" onclick="completeInstance('PHO250042')">Complete Call</button>
                                <button class="btn btn-secondary" onclick="pauseInstance('PHO250042')">Pause</button>
                                <button class="btn btn-danger" onclick="cancelInstance('PHO250042')">Cancel</button>
                            </div>
                        </div>
                        
                        <!-- Instance Row 3 - New Project -->
                        <div class="table-row" onclick="toggleInstanceDetail(this, 'PRJ250008')">
                            <div class="dna-badge">PRJ250008</div>
                            <div>Espansione Romania 2025</div>
                            <div><span class="status-badge status-new">NEW</span></div>
                            <div>2025-01-15 16:00</div>
                            <div>Marco Neri</div>
                            <div>--</div>
                            <div>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); viewInstance('PRJ250008')">üëÅÔ∏è</button>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); editInstance('PRJ250008')">‚úèÔ∏è</button>
                            </div>
                        </div>
                        <div class="instance-detail" id="detail-PRJ250008">
                            <div class="breadcrumb">
                                <span class="breadcrumb-item">Visit</span>
                                <span class="breadcrumb-separator">‚Üí</span>
                                <span class="breadcrumb-item">VIS250015</span>
                                <span class="breadcrumb-separator">‚Üí</span>
                                <span class="breadcrumb-item">Project</span>
                                <span class="breadcrumb-separator">‚Üí</span>
                                <span class="breadcrumb-item">PRJ250008</span>
                            </div>
                            <p style="color: var(--secondary); margin-bottom: 16px;">
                                This project was generated from Visit VIS250015 to discuss expansion plans.
                            </p>
                            <div class="detail-form">
                                <div class="form-group">
                                    <label class="form-label">Project Name</label>
                                    <input type="text" class="form-input" value="Espansione Romania 2025">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Client</label>
                                    <input type="text" class="form-input" value="KOOL TOOL SRL">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Budget Estimated</label>
                                    <input type="number" class="form-input" value="150000">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Deadline</label>
                                    <input type="date" class="form-input" value="2025-06-30">
                                </div>
                                <div class="form-group full-width">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-textarea">Sviluppo nuova linea produzione per mercato Est Europa</textarea>
                                </div>
                            </div>
                            <div class="action-buttons" style="margin-top: 16px;">
                                <button class="btn btn-primary" onclick="startInstance('PRJ250008')">Start Project</button>
                                <button class="btn btn-secondary" onclick="createLinkedInstance('OFC', 'PRJ250008')">Create Offer</button>
                            </div>
                        </div>
                        
                        <!-- More instances... -->
                        <div class="table-row">
                            <div class="dna-badge">OFC250023</div>
                            <div>Offerta personalizzata biondo cenere</div>
                            <div><span class="status-badge status-progress">IN_PROGRESS</span></div>
                            <div>2025-01-14 09:15</div>
                            <div>Luca Rossi</div>
                            <div>1.28 ‚ö†Ô∏è</div>
                            <div>
                                <button class="btn btn-sm">üëÅÔ∏è</button>
                                <button class="btn btn-sm">‚úèÔ∏è</button>
                            </div>
                        </div>
                        
                        <div class="table-row">
                            <div class="dna-badge">BOM250012</div>
                            <div>Kit Extension Premium 60cm</div>
                            <div><span class="status-badge status-completed">COMPLETED</span></div>
                            <div>2025-01-13 15:40</div>
                            <div>Tech Team</div>
                            <div>1.02 ‚úÖ</div>
                            <div>
                                <button class="btn btn-sm">üëÅÔ∏è</button>
                                <button class="btn btn-sm">‚úèÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Inspector -->
            <div class="right-panel">
                <div class="inspector-section">
                    <div class="inspector-title">Current Selection</div>
                    <div class="state-indicator">
                        <div class="state-icon">üìû</div>
                        <div class="state-name">Phone Call</div>
                        <div class="state-time">PHO250041</div>
                    </div>
                    
                    <div class="inspector-title">Workflow State</div>
                    <div class="state-indicator" style="background: #d1fae5;">
                        <div class="state-name">COMPLETED</div>
                        <div class="state-time">15 Jan 2025, 10:13</div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-full">Archive</button>
                        <button class="btn btn-secondary btn-full">Reopen</button>
                        <button class="btn btn-secondary btn-full">Duplicate</button>
                    </div>
                </div>
                
                <div class="inspector-section">
                    <div class="inspector-title">History</div>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-title">Completed</div>
                                <div class="timeline-time">10:13 - Sara Bianchi</div>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-title">Started</div>
                                <div class="timeline-time">10:01 - Sara Bianchi</div>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-title">Created</div>
                                <div class="timeline-time">10:00 - Sara Bianchi</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="inspector-section">
                    <div class="inspector-title">K Coefficient</div>
                    <div class="k-display">
                        <div class="k-value">1.15</div>
                        <div class="k-label">Efficiency Score</div>
                        <div class="k-status">EXCELLENT</div>
                    </div>
                    <div style="margin-top: 12px; font-size: 12px; color: var(--secondary);">
                        <div>Standard Time: 10 min</div>
                        <div>Actual Time: 12 min</div>
                        <div>Extra Cycles: 1</div>
                    </div>
                </div>
                
                <div class="inspector-section">
                    <div class="inspector-title">Quick Stats</div>
                    <div class="quick-stats">
                        <div class="stat-card">
                            <div class="stat-value">12</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">67</div>
                            <div class="stat-label">Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">289</div>
                            <div class="stat-label">Month</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Instance Modal -->
    <div id="newInstanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Instance</div>
                <button class="modal-close" onclick="closeNewInstanceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Process Type</label>
                    <div class="process-tree">
                        <div class="tree-node" onclick="selectProcessType('PHO')">üìû Phone Call (PHO)</div>
                        <div class="tree-node" onclick="selectProcessType('VIS')">üöó Customer Visit (VIS)</div>
                        <div class="tree-node" onclick="selectProcessType('PRJ')">üìÅ Project (PRJ)</div>
                        <div class="tree-node tree-node-indent">‚îî‚îÄ üìã Commercial Request</div>
                        <div class="tree-node tree-node-indent">‚îî‚îÄ üîß Technical Request</div>
                        <div class="tree-node" onclick="selectProcessType('OFC')">üíº Offer (OFC)</div>
                        <div class="tree-node" onclick="selectProcessType('BOM')">üì¶ Bill of Materials (BOM)</div>
                        <div class="tree-node" onclick="selectProcessType('ORD')">üìã Order (ORD)</div>
                    </div>
                </div>
                
                <div id="dynamicForm" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">DNA (Auto-generated)</label>
                        <input type="text" class="form-input" id="newDna" readonly style="font-family: monospace; font-weight: 600;">
                    </div>
                    <div id="templateFields"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNewInstanceModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createInstance()">Create Instance</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="toast"></div>
    
    <script>
        // Data Model
        let instances = {};
        let templates = {};
        let currentProcess = 'ALL';
        let selectedInstance = null;
        let selectedProcessType = null;
        
        // Initialize
        function init() {
            loadTemplates();
            loadInstances();
            setupAutoRefresh();
            updateDashboard();
        }
        
        // Load templates from Process Manager localStorage
        function loadTemplates() {
            const saved = localStorage.getItem('processManager3P3');
            if (saved) {
                try {
                    const processes = JSON.parse(saved);
                    templates = processes;
                } catch (e) {
                    // Create default templates if not found
                    templates = {
                        PHO: {
                            basic: { code: "PHO", name: "Phone Call", dna_format: "PHO25NNNN" },
                            attributes: [
                                { name: "caller_name", type: "TEXT", required: true },
                                { name: "phone_number", type: "PHONE", required: true },
                                { name: "duration", type: "NUMBER", required: false },
                                { name: "outcome", type: "SELECT", options: ["INTERESTED", "NOT_INTERESTED", "CALLBACK", "NO_ANSWER"], required: true },
                                { name: "notes", type: "TEXTAREA", required: false }
                            ],
                            workflow: {
                                states: ["NEW", "IN_PROGRESS", "COMPLETED", "CANCELLED"]
                            }
                        },
                        VIS: {
                            basic: { code: "VIS", name: "Visit", dna_format: "VIS25NNNN" },
                            attributes: [
                                { name: "client_name", type: "TEXT", required: true },
                                { name: "visit_date", type: "DATE", required: true },
                                { name: "purpose", type: "TEXT", required: true },
                                { name: "outcome", type: "TEXTAREA", required: false }
                            ]
                        },
                        PRJ: {
                            basic: { code: "PRJ", name: "Project", dna_format: "PRJ25NNNN" },
                            attributes: [
                                { name: "project_name", type: "TEXT", required: true },
                                { name: "client", type: "TEXT", required: true },
                                { name: "budget", type: "NUMBER", required: false },
                                { name: "deadline", type: "DATE", required: false }
                            ]
                        }
                    };
                }
            }
        }
        
        // Load instances
        function loadInstances() {
            // Load from localStorage
            for (let key in localStorage) {
                if (key.startsWith('instance_')) {
                    const instance = JSON.parse(localStorage.getItem(key));
                    instances[instance.dna] = instance;
                }
            }
            
            // Create default instances if none exist
            if (Object.keys(instances).length === 0) {
                createDefaultInstances();
            }
        }
        
        // Create default instances
        function createDefaultInstances() {
            instances['PHO250041'] = {
                dna: 'PHO250041',
                template_code: 'PHO',
                status: 'COMPLETED',
                values: {
                    caller_name: 'Mario Rossi',
                    phone_number: '+39 02 1234567',
                    duration: 12,
                    outcome: 'INTERESTED',
                    notes: 'Customer interested in spring catalog. Requesting samples of blonde extensions.'
                },
                workflow: {
                    current_state: 'COMPLETED',
                    history: [
                        {state: 'NEW', timestamp: '2025-01-15 10:00', user: 'Sara'},
                        {state: 'IN_PROGRESS', timestamp: '2025-01-15 10:01', user: 'Sara'},
                        {state: 'COMPLETED', timestamp: '2025-01-15 10:13', user: 'Sara'}
                    ]
                },
                k_coefficient: 1.15
            };
            
            instances['PHO250042'] = {
                dna: 'PHO250042',
                template_code: 'PHO',
                status: 'IN_PROGRESS',
                values: {
                    caller_name: 'Giulia Verdi',
                    phone_number: '+39 06 9876543',
                    duration: null,
                    outcome: null,
                    notes: ''
                },
                workflow: {
                    current_state: 'IN_PROGRESS',
                    history: [
                        {state: 'NEW', timestamp: '2025-01-15 14:30', user: 'Sara'},
                        {state: 'IN_PROGRESS', timestamp: '2025-01-15 14:31', user: 'Sara'}
                    ]
                }
            };
            
            instances['PRJ250008'] = {
                dna: 'PRJ250008',
                parent_dna: 'VIS250015',
                template_code: 'PRJ',
                status: 'NEW',
                values: {
                    project_name: 'Espansione Romania 2025',
                    client: 'KOOL TOOL SRL',
                    budget: 150000,
                    deadline: '2025-06-30'
                },
                workflow: {
                    current_state: 'NEW',
                    history: [
                        {state: 'NEW', timestamp: '2025-01-15 16:00', user: 'Marco'}
                    ]
                }
            };
            
            saveInstances();
        }
        
        // Save instances to localStorage
        function saveInstances() {
            for (let dna in instances) {
                localStorage.setItem(`instance_${dna}`, JSON.stringify(instances[dna]));
            }
        }
        
        // Toggle instance detail
        function toggleInstanceDetail(row, dna) {
            const detail = document.getElementById(`detail-${dna}`);
            const wasActive = detail.classList.contains('active');
            
            // Close all details
            document.querySelectorAll('.instance-detail').forEach(d => {
                d.classList.remove('active');
            });
            document.querySelectorAll('.table-row').forEach(r => {
                r.classList.remove('expanded');
            });
            
            // Open clicked detail if it wasn't already open
            if (!wasActive) {
                detail.classList.add('active');
                row.classList.add('expanded');
                selectedInstance = dna;
                updateInspector(dna);
            }
        }
        
        // Update inspector panel
        function updateInspector(dna) {
            const instance = instances[dna];
            if (!instance) return;
            
            // Update current selection
            // Update workflow state
            // Update history
            // Update K coefficient
            // This would be fully implemented in production
        }
        
        // Open new instance modal
        function openNewInstanceModal() {
            document.getElementById('newInstanceModal').classList.add('active');
        }
        
        // Close new instance modal
        function closeNewInstanceModal() {
            document.getElementById('newInstanceModal').classList.remove('active');
            document.getElementById('dynamicForm').style.display = 'none';
            selectedProcessType = null;
        }
        
        // Select process type
        function selectProcessType(type) {
            selectedProcessType = type;
            
            // Highlight selected
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Generate new DNA
            const nextDna = generateDNA(type);
            document.getElementById('newDna').value = nextDna;
            
            // Generate form fields from template
            generateDynamicForm(type);
            
            document.getElementById('dynamicForm').style.display = 'block';
        }
        
        // Generate DNA with anti-collision
        function generateDNA(type) {
            const year = new Date().getFullYear().toString().slice(-2);
            let counter = 1;
            
            // Find highest existing counter
            for (let dna in instances) {
                if (dna.startsWith(type + year)) {
                    const num = parseInt(dna.slice(-4));
                    if (num >= counter) counter = num + 1;
                }
            }
            
            return `${type}${year}${String(counter).padStart(4, '0')}`;
        }
        
        // Generate dynamic form from template
        function generateDynamicForm(type) {
            const template = templates[type];
            if (!template) return;
            
            let html = '';
            template.attributes.forEach(attr => {
                html += '<div class="form-group">';
                html += `<label class="form-label">${attr.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
                if (attr.required) html += ' *';
                html += '</label>';
                
                if (attr.type === 'TEXTAREA') {
                    html += `<textarea class="form-textarea" name="${attr.name}"></textarea>`;
                } else if (attr.type === 'SELECT') {
                    html += `<select class="form-select" name="${attr.name}">`;
                    html += '<option value="">-- Select --</option>';
                    attr.options.forEach(opt => {
                        html += `<option value="${opt}">${opt}</option>`;
                    });
                    html += '</select>';
                } else if (attr.type === 'DATE') {
                    html += `<input type="date" class="form-input" name="${attr.name}">`;
                } else if (attr.type === 'NUMBER') {
                    html += `<input type="number" class="form-input" name="${attr.name}">`;
                } else if (attr.type === 'PHONE') {
                    html += `<input type="tel" class="form-input" name="${attr.name}">`;
                } else {
                    html += `<input type="text" class="form-input" name="${attr.name}">`;
                }
                
                html += '</div>';
            });
            
            document.getElementById('templateFields').innerHTML = html;
        }
        
        // Create instance
        function createInstance() {
            if (!selectedProcessType) {
                showToast('Please select a process type');
                return;
            }
            
            const dna = document.getElementById('newDna').value;
            const values = {};
            
            // Collect form values
            document.querySelectorAll('#templateFields [name]').forEach(field => {
                values[field.name] = field.value;
            });
            
            // Create instance
            instances[dna] = {
                dna: dna,
                template_code: selectedProcessType,
                status: 'NEW',
                values: values,
                workflow: {
                    current_state: 'NEW',
                    history: [{
                        state: 'NEW',
                        timestamp: new Date().toISOString(),
                        user: 'Sara'
                    }]
                }
            };
            
            saveInstances();
            closeNewInstanceModal();
            showToast(`Instance ${dna} created successfully`);
            
            // Reload table
            location.reload();
        }
        
        // Create linked instance
        function createLinkedInstance(type, parentDna) {
            selectedProcessType = type;
            openNewInstanceModal();
            selectProcessType(type);
            
            // Set parent DNA in a hidden field or breadcrumb
            // This would link the instances
            showToast(`Creating ${type} linked to ${parentDna}`);
        }
        
        // Complete instance
        function completeInstance(dna) {
            instances[dna].status = 'COMPLETED';
            instances[dna].workflow.current_state = 'COMPLETED';
            instances[dna].workflow.history.push({
                state: 'COMPLETED',
                timestamp: new Date().toISOString(),
                user: 'Sara'
            });
            
            // Calculate K coefficient
            const standardTime = 10; // minutes
            const actualTime = instances[dna].values.duration || 15;
            instances[dna].k_coefficient = (actualTime / standardTime).toFixed(2);
            
            saveInstances();
            showToast(`Instance ${dna} completed`);
            location.reload();
        }
        
        // Filter functions
        function filterByStatus(status) {
            document.querySelectorAll('.filter-option').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter table rows
            // This would be implemented in production
            showToast(`Filtering by status: ${status}`);
        }
        
        // Switch process tab
        function switchProcess(process) {
            currentProcess = process;
            document.querySelectorAll('.process-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter instances by process
            // This would be implemented in production
        }
        
        // Switch view
        function switchView(view) {
            document.querySelectorAll('.view-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === 'kanban') {
                showToast('Kanban view coming soon!');
            } else if (view === 'timeline') {
                showToast('Timeline view coming soon!');
            }
        }
        
        // View instance
        function viewInstance(dna) {
            showToast(`Viewing instance ${dna}`);
        }
        
        // Edit instance
        function editInstance(dna) {
            showToast(`Editing instance ${dna}`);
        }
        
        // Start instance
        function startInstance(dna) {
            instances[dna].status = 'IN_PROGRESS';
            instances[dna].workflow.current_state = 'IN_PROGRESS';
            saveInstances();
            showToast(`Instance ${dna} started`);
            location.reload();
        }
        
        // Pause instance
        function pauseInstance(dna) {
            showToast(`Instance ${dna} paused`);
        }
        
        // Cancel instance
        function cancelInstance(dna) {
            instances[dna].status = 'CANCELLED';
            instances[dna].workflow.current_state = 'CANCELLED';
            saveInstances();
            showToast(`Instance ${dna} cancelled`);
            location.reload();
        }
        
        // Show toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('active');
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
        
        // Setup auto-refresh
        function setupAutoRefresh() {
            setInterval(() => {
                // In production, this would fetch new data from server
                console.log('Auto-refresh check...');
            }, 30000); // Every 30 seconds
        }
        
        // Update dashboard stats
        function updateDashboard() {
            // Count instances by status
            // Update badges
            // This would be fully implemented in production
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    

    function openInVSCode() {
      const githubBase = "https://caufero.github.io";
      const localBase = "file:///Users/cyril/Documents/Caufero%20Apps";
      
      const currentURL = window.location.href;
      const localPath = currentURL.replace(githubBase, localBase);
      
      // Convert file:// path to vscode:// path
      const vscodePath = localPath.replace("file://", "vscode://file/");
      
      window.location.href = vscodePath;
    }
  </script>
</body>
</html>